{% extends 'layout.html' %}

{% block content %}
<div class="row g-4">
    <!-- Left sidebar: Chat sessions -->
    <div class="col-lg-3">
        <div class="card" style="transform-style: preserve-3d; transform: translateZ(var(--depth-3));">
            <div class="card-header">
                <h5 class="mb-0 fs-6"><i class="fas fa-lightbulb me-2"></i>Th√¥ng tin li√™n h·ªá</h5>
            </div>
            <div class="card-body p-2">
                <div class="d-grid gap-2">
                    <a href="https://tuyensinh.ou.edu.vn/" target="_blank" class="redirect-link" style="transform-style: preserve-3d; transform: translateZ(var(--depth-2)); transition: transform 0.3s ease;">üåê Trang web tuy·ªÉn sinh</a>
                    <a href="https://www.oucommunity.dev/" target="_blank" class="redirect-link" style="transform-style: preserve-3d; transform: translateZ(var(--depth-2)); transition: transform 0.3s ease;">üìî S·ªï tay tuy·ªÉn sinh OU</a>
                    <a href="https://www.facebook.com/tuyensinh.ou.edu.vn" target="_blank" class="redirect-link" style="transform-style: preserve-3d; transform: translateZ(var(--depth-2)); transition: transform 0.3s ease;">‚ö° Facebook</a>
                    <a href="https://www.tiktok.com/@tuyensinh.hcmcou" target="_blank" class="redirect-link" style="transform-style: preserve-3d; transform: translateZ(var(--depth-2)); transition: transform 0.3s ease;">üéµ Tiktok</a>
                    <span><strong>üìß Email: </strong><a href="mailto:tuyensinh@ou.edu.vn target="_blank class="redirect-link" style="transform-style: preserve-3d; transform: translateZ(var(--depth-2)); transition: transform 0.3s ease;">tuyensinh@ou.edu.vn</a></span>        
                    <span><strong>üìû Hotline: </strong>1800585884</span>
                </div>
            </div>
        </div>

        <div class="card" style="transform-style: preserve-3d; transform: translateZ(var(--depth-3));">
            <div class="card-header">
                <h5 class="mb-0 fs-6"><i class="fas fa-lightbulb me-2"></i>M·∫´u c√¢u h·ªèi</h5>
            </div>
            <div class="card-body p-2">
                <div class="d-grid gap-2">
                    <button class="btn btn-sm text-start sample-question" style="transform-style: preserve-3d; transform: translateZ(var(--depth-2)); transition: transform 0.3s ease;">Ch·ªâ ti√™u tuy·ªÉn sinh nƒÉm 2025?</button>
                    <button class="btn btn-sm text-start sample-question" style="transform-style: preserve-3d; transform: translateZ(var(--depth-2)); transition: transform 0.3s ease;">C√°c ph∆∞∆°ng th·ª©c tuy·ªÉn sinh c·ªßa tr∆∞·ªùng?</button>
                    <button class="btn btn-sm text-start sample-question" style="transform-style: preserve-3d; transform: translateZ(var(--depth-2)); transition: transform 0.3s ease;">ƒêi·ªÉm chu·∫©n ng√†nh C√¥ng ngh·ªá th√¥ng tin?</button>
                    <button class="btn btn-sm text-start sample-question" style="transform-style: preserve-3d; transform: translateZ(var(--depth-2)); transition: transform 0.3s ease;">H·ªçc ph√≠ ng√†nh Ng√¥n ng·ªØ Anh nƒÉm 2025 l√† bao nhi√™u?</button>
                    <button class="btn btn-sm text-start sample-question" style="transform-style: preserve-3d; transform: translateZ(var(--depth-2)); transition: transform 0.3s ease;">C∆° h·ªôi vi·ªác l√†m ng√†nh Ki·ªÉm to√°n?</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main chat area -->
    <div class="col-lg-9">
        <div class="card mb-4" style="transform-style: preserve-3d; transform: translateZ(var(--depth-3));">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0" id="current-chat-title" style="text-shadow: 0 1px 2px rgba(115, 103, 240, 0.2);">
                    <i class="fas fa-robot me-2"></i>Tr·ª£ l√Ω tuy·ªÉn sinh
                </h5>
                <div>
                    <button id="clear-button" class="btn btn-sm btn-outline-danger me-2" style="transform-style: preserve-3d; transform: translateZ(var(--depth-1));">
                        <i class="fas fa-trash-alt me-1"></i>X√≥a ƒëo·∫°n chat
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="chat-container">
                    <div id="chat-messages" class="chat-messages p-3" style="height: 500px; overflow-y: auto;">
                        <!-- Welcome message -->
                        <div class="message bot-message p-3 mb-3 rounded-3">
                            <h4 class="mb-3 text-gradient">Ch√†o m·ª´ng b·∫°n!</h4>
                            <p class="mb-2">T√¥i l√† tr·ª£ l√Ω ·∫£o c·ªßa <strong>Tr∆∞·ªùng ƒê·∫°i h·ªçc M·ªü Th√†nh ph·ªë H·ªì Ch√≠ Minh</strong>, t√¥i c√≥ th·ªÉ gi√∫p b·∫°n:</p>
                            <ul class="mb-3">
                                <li>T√¨m hi·ªÉu v·ªÅ ng√†nh h·ªçc v√† ch·ªâ ti√™u tuy·ªÉn sinh nƒÉm 2025</li>
                                <li>Tra c·ª©u c√°c ph∆∞∆°ng th·ª©c tuy·ªÉn sinh</li>
                                <li>T√¨m hi·ªÉu v·ªÅ ƒëi·ªÅu ki·ªán ƒëƒÉng k√Ω v√† quy ƒë·ªïi ƒëi·ªÉm</li>
                                <li>Tra c·ª©u th√¥ng tin v·ªÅ h·ªçc ph√≠ v√† h·ªçc b·ªïng</li>
                            </ul>
                            <p>H√£y ƒë·∫∑t c√¢u h·ªèi ƒë·ªÉ t√¥i c√≥ th·ªÉ gi√∫p b·∫°n!</p>
                            <small class="text-muted">* Th√¥ng tin ƒë∆∞·ª£c l·∫•y t·ª´ d·ªØ li·ªáu tuy·ªÉn sinh m·ªõi nh·∫•t 2025</small>
                        </div>
                    </div>
                    <div class="chat-input p-3 border-top" style="transform-style: preserve-3d; transform: translateZ(var(--depth-2));">
                        <form id="chat-form" class="d-flex align-items-center gap-2">
                            <input type="text" id="message-input" class="form-control" placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n..." style="border-radius: var(--btn-border-radius); box-shadow: var(--shadow-sm);">
                            <button type="submit" id="send-button" class="btn btn-primary px-4" style="transform-style: preserve-3d; transform: translateZ(var(--depth-2));">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
/* Styles for bot message content */
.bot-message h4 {
    margin-bottom: 1rem;
    font-weight: 600;
}

.bot-message p {
    margin-bottom: 0.75rem;
}

.bot-message ul, .bot-message ol {
    margin-bottom: 1rem;
    padding-left: 1.5rem;
}

.bot-message table, .bot-message .data-table {
    margin-bottom: 1rem;
    width: 100%;
    border-collapse: collapse;
}

.bot-message table td, .bot-message table th,
.bot-message .data-row {
    padding: 0.5rem;
    border: 1px solid #dee2e6;
}

.bot-message .data-table {
    display: table;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    overflow: hidden;
}

.bot-message .data-row {
    display: table-row;
}

.bot-message .data-label, .bot-message .data-value {
    display: table-cell;
    padding: 0.5rem;
    border-bottom: 1px solid #dee2e6;
}

.bot-message .data-label {
    font-weight: 500;
    background-color: rgba(115, 103, 240, 0.05);
}

.bot-message .text-gradient {
    background: linear-gradient(45deg, #7367f0, #ce9ffc);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
}

.bot-message .text-accent {
    color: #7367f0;
    font-weight: bold;
}

.bot-message .source-info {
    margin-top: 1rem;
    color: #6c757d;
}

.bot-message .content-section {
    margin-bottom: 1rem;
}

.bot-message .feature-list li {
    margin-bottom: 0.5rem;
}

.bot-message small {
    font-size: 85%;
}

.d-grid a {
    text-decoration: none;
}

.redirect-link:hover {
    color: #ff5733;
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let chatHistory = [];

// Initialize the application when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Load chat sessions
    loadChatHistory();
    
    // Set up event listeners
    // document.getElementById('new-chat-button').addEventListener('click', createNewSession);
    // document.getElementById('new-chat-sidebar').addEventListener('click', createNewSession);
    document.getElementById('clear-button').addEventListener('click', clearChat);
    document.getElementById('chat-form').addEventListener('submit', function(e) {
        e.preventDefault();
        sendMessage();
    });
    
    // Set up sample question buttons
    document.querySelectorAll('.sample-question').forEach(button => {
        button.addEventListener('click', function() {
            document.getElementById('message-input').value = this.textContent;
            sendMessage();
        });
    });
});

// Load chat history from the server
function loadChatHistory() {
    fetch('/api/current_chat_history')
        .then(response => response.json())
        .then(history => {
            chatHistory = history;
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = '';
            
            // Add welcome message if history is empty
            if (chatHistory.length === 0) {
                const welcomeMessage = document.createElement('div');
                welcomeMessage.className = 'message bot-message p-3 mb-3 rounded-3';
                welcomeMessage.innerHTML = `
                    <h4 class="mb-3 text-gradient">Ch√†o m·ª´ng b·∫°n!</h4>
                    <p class="mb-2">T√¥i l√† tr·ª£ l√Ω ·∫£o c·ªßa <strong>Tr∆∞·ªùng ƒê·∫°i h·ªçc M·ªü Th√†nh ph·ªë H·ªì Ch√≠ Minh</strong>, t√¥i c√≥ th·ªÉ gi√∫p b·∫°n:</p>
                    <ul class="mb-3">
                        <li>T√¨m hi·ªÉu v·ªÅ ng√†nh h·ªçc v√† ch·ªâ ti√™u tuy·ªÉn sinh nƒÉm 2025</li>
                        <li>Tra c·ª©u c√°c ph∆∞∆°ng th·ª©c tuy·ªÉn sinh</li>
                        <li>T√¨m hi·ªÉu v·ªÅ ƒëi·ªÅu ki·ªán ƒëƒÉng k√Ω v√† quy ƒë·ªïi ƒëi·ªÉm</li>
                        <li>Tra c·ª©u th√¥ng tin v·ªÅ h·ªçc ph√≠ v√† h·ªçc b·ªïng</li>
                    </ul>
                    <p>H√£y ƒë·∫∑t c√¢u h·ªèi ƒë·ªÉ t√¥i c√≥ th·ªÉ gi√∫p b·∫°n!</p>
                    <small class="text-muted">* Th√¥ng tin ƒë∆∞·ª£c l·∫•y t·ª´ d·ªØ li·ªáu tuy·ªÉn sinh m·ªõi nh·∫•t 2025</small>
                `;
                chatMessages.appendChild(welcomeMessage);
            } else {
                // Add all messages from history
                chatHistory.forEach(msg => {
                    addMessage(msg.content, msg.role);
                });
            }
            scrollToBottom();
        })
        .catch(error => {
            console.error('Error loading chat history:', error);
        });
}

// Send a message to the AI
function sendMessage() {
    const messageInput = document.getElementById('message-input');
    const userMessage = messageInput.value.trim();
    
    if (userMessage === '') return;
    
    // Add user message to chat
    addMessage(userMessage, 'user');
    messageInput.value = '';
    
    // Show typing indicator
    const typingIndicator = document.createElement('div');
    typingIndicator.id = 'typing-indicator';
    typingIndicator.className = 'message bot-message p-3 mb-3 rounded-3';
    typingIndicator.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
    document.getElementById('chat-messages').appendChild(typingIndicator);
    scrollToBottom();
    
    // Send request to server
    fetch('/chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ message: userMessage })
    })
    .then(response => response.json())
    .then(data => {
        // Remove typing indicator if it exists
        const typingIndicator = document.getElementById('typing-indicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }

        // Check for errors 
        if (data.error) {
            addMessage(data.error, 'assistant', true);
            scrollToBottom();
            return;
        }

        // Update chat history
        if (data.chat_history) {
            chatHistory = data.chat_history;
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = ''; // Clear current chat
            chatHistory.forEach(msg => { 
                addMessage(msg.content, msg.role);
            });
        }
        scrollToBottom();
    })

    .catch(error => {
        // Remove typing indicator
        if (document.getElementById('typing-indicator')) {
            document.getElementById('typing-indicator').remove();
        }
        
        // Show error message
        addMessage('ƒê√£ x·∫£y ra l·ªói khi x·ª≠ l√Ω y√™u c·∫ßu c·ªßa b·∫°n. Vui l√≤ng th·ª≠ l·∫°i sau.', 'assistant', true);
        console.error('Error sending message:', error);
    }).finally(() => {
        // Clear input after sending
        messageInput.value = '';
    });
}

// Add a message to the chat
function addMessage(text, sender, isError = false) {
    const chatMessages = document.getElementById('chat-messages');
    const messageElement = document.createElement('div');
    
    // Set appropriate classes
    messageElement.className = `message ${sender === 'user' ? 'user-message ms-auto' : 'bot-message'} p-3 mb-3 rounded-3`;
    if (sender === 'user') {
        messageElement.style.maxWidth = '80%';
    } else {
        messageElement.style.maxWidth = '90%';
    }
    
    // Add error class if needed
    if (isError) {
        messageElement.classList.add('error-message');
    }
    
    // Set message content
    if (sender === 'user') {
        messageElement.textContent = text;
    } else {
        // For AI messages, process and clean up HTML content
        
        // 1. Remove markdown code block markers if present
        let processedText = text;
        // Remove ```html and ``` markers
        processedText = processedText.replace(/```html/g, '');
        processedText = processedText.replace(/```/g, '');
        
        // 2. Replace any HTML entity escaping
        processedText = processedText.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&');
        
        // 3. Create a temporary div to ensure HTML is valid
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = processedText;
        
        // 4. Check if the content was properly parsed as HTML
        if (tempDiv.innerHTML === processedText && processedText.includes('<') && processedText.includes('>')) {
            console.error('HTML parsing failed, falling back to direct assignment');
            messageElement.innerHTML = processedText;
        } else {
            // The HTML was properly parsed, use the parsed content
            messageElement.innerHTML = tempDiv.innerHTML;
        }
        
        // 5. Add debug information to console
        console.log('Original text:', text.substring(0, 100) + '...');
        console.log('Processed text:', processedText.substring(0, 100) + '...');
    }
    
    // Add message to chat
    chatMessages.appendChild(messageElement);
    scrollToBottom();
}

// Clear the current chat
function clearChat() {
    if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·∫•t c·∫£ tin nh·∫Øn trong ƒëo·∫°n chat n√†y kh√¥ng?')) return;
    
    fetch('/clear_chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        // Clear chat messages
        document.getElementById('chat-messages').innerHTML = '';
        
        // Add welcome message
        const welcomeMessage = document.createElement('div');
        welcomeMessage.className = 'message bot-message p-3 mb-3 rounded-3';
        welcomeMessage.innerHTML = `
            <h4 class="mb-3 text-gradient">Ch√†o m·ª´ng b·∫°n!</h4>
            <p class="mb-2">T√¥i l√† tr·ª£ l√Ω ·∫£o c·ªßa <strong>Tr∆∞·ªùng ƒê·∫°i h·ªçc M·ªü Th√†nh ph·ªë H·ªì Ch√≠ Minh</strong>, t√¥i c√≥ th·ªÉ gi√∫p b·∫°n:</p>
            <ul class="mb-3">
                <li>T√¨m hi·ªÉu v·ªÅ ng√†nh h·ªçc v√† ch·ªâ ti√™u tuy·ªÉn sinh nƒÉm 2025</li>
                <li>Tra c·ª©u c√°c ph∆∞∆°ng th·ª©c tuy·ªÉn sinh</li>
                <li>T√¨m hi·ªÉu v·ªÅ ƒëi·ªÅu ki·ªán ƒëƒÉng k√Ω v√† quy ƒë·ªïi ƒëi·ªÉm</li>
                <li>Tra c·ª©u th√¥ng tin v·ªÅ h·ªçc ph√≠ v√† h·ªçc b·ªïng</li>
            </ul>
            <p>H√£y ƒë·∫∑t c√¢u h·ªèi ƒë·ªÉ t√¥i c√≥ th·ªÉ gi√∫p b·∫°n!</p>
            <small class="text-muted">* Th√¥ng tin ƒë∆∞·ª£c l·∫•y t·ª´ d·ªØ li·ªáu tuy·ªÉn sinh m·ªõi nh·∫•t 2025</small>
        `;
        document.getElementById('chat-messages').appendChild(welcomeMessage);
    })
    .catch(error => {
        console.error('Error clearing chat:', error);
    });
}

// Utility function to scroll to the bottom of the chat
function scrollToBottom() {
    const chatMessages = document.getElementById('chat-messages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Format date for display
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('vi-VN', { 
        month: '2-digit', 
        day: '2-digit',
        hour: '2-digit', 
        minute: '2-digit'
    });
}
</script>
{% endblock %}
